<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2d0a1e 0%, #1a0a2e 50%, #2d0a1e 100%);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #880e4f 0%, #2d0a1e 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .logout-btn {
            float: right;
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .upload-section {
            background: rgba(255,255,255,0.07);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .upload-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group select,
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #c2185b, #880e4f);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .upload-btn:hover {
            background: #880e4f;
        }
        
        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .media-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .media-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f0f0f0;
        }
        
        .media-info {
            padding: 15px;
        }
        
        .media-tag {
            background: #880e4f;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .progress {
            margin-top: 15px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #c2185b, #880e4f);
            width: 0%;
            transition: width 0.3s;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="logout-btn" id="logoutBtn" onclick="logout()">Logout</button>
        <h1>ðŸ’œ Creator Dashboard</h1>
        <p id="creatorName"></p>
    </div>
    
    <div class="container">
        <!-- Picture of the Day -->
        <div class="upload-section">
            <h2 style="color:#fff;">ðŸ“… Picture of the Day</h2>
            <p style="color:#ccc;font-size:13px;margin-bottom:16px;">One photo per day. Clients pay 1 rose to unlock it.</p>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                <select id="potdDate" style="flex:1;min-width:130px;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                    <option value="">-- Select day --</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>
                <input type="text" id="potdTitle" placeholder="Title (optional)" style="flex:1;min-width:130px;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                <input type="file" id="potdFile" accept="image/*" style="flex:1;min-width:130px;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;">
            </div>
            <div class="progress" id="potdProgress">
                <div class="progress-bar"><div class="progress-fill" id="potdProgressFill"></div></div>
            </div>
            <button class="upload-btn" id="potdBtn" onclick="uploadPotd()" style="width:100%;margin-bottom:16px;">Upload Picture of the Day</button>
            <div id="potdList"></div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <h2 style="color:#fff;">Upload New Content</h2>
            <div class="form-group">
                <label>Content Type</label>
                <select id="contentType">
                    <option value="selfie">Selfie</option>
                    <option value="bikini">Bikini</option>
                    <option value="lingerie">Lingerie</option>
                    <option value="gym">Gym/Fitness</option>
                    <option value="casual">Casual</option>
                    <option value="dressy">Dressy/Formal</option>
                    <option value="video">Video</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Select File (Image or Video)</label>
                <input type="file" id="fileInput" accept="image/*,video/*">
            </div>
            <div class="progress" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <button class="upload-btn" id="uploadBtn" onclick="uploadContent()">Upload Content</button>
        </div>

        <!-- Media Gallery -->
        <div class="upload-section">
            <h2 style="color:#fff;">Your Content</h2>
            <div id="mediaContainer" class="media-grid">
                <div class="loading">Loading your content...</div>
            </div>
        </div>

        <!-- Availability Section -->
        <div class="upload-section">
            <h2 style="color:#fff;">ðŸ“… My Availability</h2>
            <p style="color:#ccc;font-size:14px;margin-bottom:16px;">Set which times you're available for video calls. Clients will only see these slots when booking.</p>
            <div id="availGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:16px;text-align:center;font-size:12px;">
                <div style="font-weight:600;color:#999;">Mon</div>
                <div style="font-weight:600;color:#999;">Tue</div>
                <div style="font-weight:600;color:#999;">Wed</div>
                <div style="font-weight:600;color:#999;">Thu</div>
                <div style="font-weight:600;color:#999;">Fri</div>
                <div style="font-weight:600;color:#999;">Sat</div>
                <div style="font-weight:600;color:#999;">Sun</div>
            </div>
            <div id="timeSlotPicker" style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;"></div>
            <button class="upload-btn" id="saveAvailBtn" onclick="saveAvailability()">Save Availability</button>
            <div id="availMsg" style="margin-top:10px;font-size:14px;color:#27ae60;display:none;">âœ“ Availability saved</div>
        </div>

        <!-- Bookings Section -->
        <div class="upload-section">
            <h2 style="color:#fff;">ðŸ“¹ Upcoming Video Calls</h2>
            <div id="bookingsContainer">
                <div class="loading">Loading bookings...</div>
            </div>
        </div>

    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyArbpb25d8UwEL5bE46Oe8yAMTMM1BoGzU",
            authDomain: "velvet-app-1733e.firebaseapp.com",
            projectId: "velvet-app-1733e",
            storageBucket: "velvet-app-1733e.firebasestorage.app",
            messagingSenderId: "514672347699",
            appId: "1:514672347699:web:a70516f6383e0069a7f146"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentCreator = null;
        
        // Check auth
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'creator-login.html';
                return;
            }
            
            // Look up creator by checking if user email matches any creator email
console.log('Looking for creator with email:', user.email);
const creatorsQuery = query(collection(db, 'creators'), where('email', '==', user.email.toLowerCase()));
const creatorsSnapshot = await getDocs(creatorsQuery);
console.log('Found creators:', creatorsSnapshot.size);

if (creatorsSnapshot.empty) {
    await signOut(auth);
    alert('Not authorized as creator. Email: ' + user.email + ' not found in creators.');
    window.location.href = 'auth.html';
    return;
}

const creatorDoc = creatorsSnapshot.docs[0];
currentCreator = { id: creatorDoc.id, ...creatorDoc.data() };
            document.getElementById('creatorName').textContent = `${currentCreator.name} â€¢ Code: ${currentCreator.code}`;
            window._creatorFirstName = currentCreator.name.split(' ')[0];
            loadMedia();
            loadPotdList();
                loadAvailability(currentCreator.code);
                loadBookings(currentCreator.code);
            // Set today as default date
            // potdDate is now a day dropdown
        });
        
        // Upload content
        window.uploadContent = async function() {
            const fileInput = document.getElementById('fileInput');
            const contentType = document.getElementById('contentType').value;
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            // Max 50MB
            if (file.size > 50 * 1024 * 1024) {
                alert('File too large. Maximum 50MB');
                return;
            }
            
            try {
                const uploadBtn = document.getElementById('uploadBtn');
                const progress = document.getElementById('uploadProgress');
                const progressFill = document.getElementById('progressFill');
                
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';
                progress.style.display = 'block';
                
                // Upload to Firebase Storage
                const timestamp = Date.now();
                const fileName = `${currentCreator.code}/${timestamp}_${file.name}`;
                const storageRef = ref(storage, `creator-content/${fileName}`);
                const uploadTask = uploadBytesResumable(storageRef, file);
                
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const percent = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressFill.style.width = percent + '%';
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        alert('Upload failed: ' + error.message);
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload Content';
                        progress.style.display = 'none';
                    },
                    async () => {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        
                        // Save to Firestore
                        await addDoc(collection(db, 'media'), {
                            creatorCode: currentCreator.code,
                            creatorId: currentCreator.id,
                            type: contentType,
                            url: downloadURL,
                            fileName: fileName,
                            fileType: file.type.startsWith('image') ? 'image' : 'video',
                            uploadedAt: new Date()
                        });
                        
                        alert('âœ“ Content uploaded successfully!');
                        fileInput.value = '';
                        progressFill.style.width = '0%';
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload Content';
                        progress.style.display = 'none';
                        loadMedia();
                    }
                );
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            }
        }
        
        // Load media
        async function loadMedia() {
            const container = document.getElementById('mediaContainer');
            try {
                const res = await fetch('https://velvet-chat-jjxw.vercel.app/api/media?mode=list&creatorCode=' + currentCreator.code);
                const data = await res.json();
                if (!data.success || !data.items || data.items.length === 0) {
                    container.innerHTML = '<div class="loading">No content uploaded yet</div>';
                    return;
                }
                container.innerHTML = data.items.map(item => {
                    const isVideo = item.fileType === 'video';
                    return `
                        <div class="media-card">
                            ${isVideo ?
                                `<video class="media-preview" controls><source src="${item.url}"></video>` :
                                `<img class="media-preview" src="${item.url}" alt="${item.type}">`
                            }
                            <div class="media-info">
                                <div class="media-tag">${item.type}</div>
                                <button class="delete-btn" onclick="deleteMedia('${item.id}', '${item.fileName}')">Delete</button>
                            </div>
                        </div>`;
                }).join('');
            } catch (error) {
                console.error('Load error:', error);
                container.innerHTML = '<div class="loading">Error loading content</div>';
            }
        }
        
        // Delete media
        window.deleteMedia = async function(docId, fileName) {
            if (!confirm('Delete this content?')) return;
            
            try {
                // Delete from Storage
                const storageRef = ref(storage, `creator-content/${fileName}`);
                await deleteObject(storageRef);
                
                // Delete from Firestore
                await deleteDoc(doc(db, 'media', docId));
                
                alert('âœ“ Content deleted');
                loadMedia();
            } catch (error) {
                console.error('Delete error:', error);
                alert('Delete failed: ' + error.message);
            }
        }
        
        // Upload Picture of the Day
        window.uploadPotd = async function() {
            const file = document.getElementById('potdFile').files[0];
            const date = document.getElementById('potdDate').value;
            const title = document.getElementById('potdTitle').value || 'Picture of the Day';

            if (!file) { alert('Please select a photo'); return; }
            if (!date || date === '') { alert('Please select a day'); return; }

            const btn = document.getElementById('potdBtn');
            const progress = document.getElementById('potdProgress');
            const fill = document.getElementById('potdProgressFill');
            btn.disabled = true;
            btn.textContent = 'Uploading...';
            progress.style.display = 'block';

            const timestamp = Date.now();
            const fileName = `${currentCreator.code}/potd/${timestamp}_${file.name}`;
            const storageRef = ref(storage, `creator-content/${fileName}`);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed',
                (snap) => { fill.style.width = (snap.bytesTransferred/snap.totalBytes*100) + '%'; },
                (err) => { alert('Upload failed: ' + err.message); btn.disabled=false; btn.textContent='Upload Picture of the Day'; progress.style.display='none'; },
                async () => {
                    const url = await getDownloadURL(uploadTask.snapshot.ref);
                    await addDoc(collection(db, 'picture_of_day'), {
                        creatorCode: currentCreator.code,
                        day: date,
                        url: url,
                        title: title,
                        cost: 1,
                        uploadedAt: new Date()
                    });
                    alert('âœ“ Picture of the Day uploaded!');
                    document.getElementById('potdFile').value = '';
                    document.getElementById('potdTitle').value = '';
                    fill.style.width = '0%';
                    btn.disabled = false;
                    btn.textContent = 'Upload Picture of the Day';
                    progress.style.display = 'none';
                    loadPotdList();
                }
            );
        }

        // Load existing POTD entries
        const DAY_NAMES = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

        async function loadPotdList() {
            const container = document.getElementById('potdList');
            const byDay = {};
            DAY_NAMES.forEach(d => byDay[d] = []);
            try {
                const res = await fetch('https://velvet-chat-jjxw.vercel.app/api/media?mode=potd&creatorCode=' + currentCreator.code);
                const data = await res.json();
                if (data.success && data.entries) {
                    data.entries.forEach(p => {
                        const dayName = p.day || '';
                        if (byDay[dayName] !== undefined) byDay[dayName].push(p);
                    });
                }
            } catch(e) { console.error('POTD load error:', e); }

            container.innerHTML = '<div style="display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;">' +
                DAY_NAMES.map(day => {
                    const entries = byDay[day];
                    const p = entries[0];
                    return `<div style="flex:0 0 80px;text-align:center;">
                        <div style="font-size:11px;font-weight:700;color:#555;margin-bottom:4px;">${day.slice(0,3)}</div>
                        ${p
                            ? `<div style="position:relative;">
                                <img src="${p.url}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:2px solid #6B46C1;">
                                <button onclick="deletePotd('${p.id}')" style="position:absolute;top:-6px;right:-6px;background:#e74c3c;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;line-height:20px;">Ã—</button>
                               </div>`
                            : `<div style="width:80px;height:80px;border-radius:8px;border:2px dashed #ddd;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:24px;">+</div>`
                        }
                    </div>`;
                }).join('') + '</div>';
        }

        window.deletePotd = async function(id) {
            if (!confirm('Delete this Picture of the Day?')) return;
            await fetch('https://velvet-chat-jjxw.vercel.app/api/media?mode=potd&creatorCode=' + currentCreator.code + '&id=' + id, { method: 'DELETE' });
            loadPotdList();
        }


        // â”€â”€ AVAILABILITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const HOURS = [8,9,10,11,12,13,14,15,16,17,18,19,20,21];
        // selectedSlots: Set of "dayIndex_hour_minute" strings e.g. "0_14_0"
        let selectedSlots = new Set();

        function buildTimePicker(existingSlots) {
            selectedSlots = new Set(existingSlots || []);
            const container = document.getElementById('timeSlotPicker');
            let html = '';

            HOURS.forEach(hour => {
                const label = (hour < 12 ? hour : hour === 12 ? 12 : hour-12) + ':00 ' + (hour < 12 ? 'AM' : 'PM');
                html += '<div style="display:grid;grid-template-columns:60px repeat(7,1fr);gap:6px;align-items:center;">';
                html += '<div style="font-size:12px;color:#999;">' + label + '</div>';
                DAYS.forEach((day, dayIdx) => {
                    const key = dayIdx + '_' + hour + '_0';
                    const selected = selectedSlots.has(key);
                    html += `<div onclick="toggleSlot(this,'${key}')" style="height:32px;border-radius:6px;cursor:pointer;background:${selected ? '#1e3a8a' : '#f0f0f0'};border:2px solid ${selected ? '#1e3a8a' : 'transparent'};" data-key="${key}"></div>`;
                });
                html += '</div>';
            });

            container.innerHTML = html;
        }

        window.toggleSlot = function(el, key) {
            if (selectedSlots.has(key)) {
                selectedSlots.delete(key);
                el.style.background = '#f0f0f0';
                el.style.borderColor = 'transparent';
            } else {
                selectedSlots.add(key);
                el.style.background = '#1e3a8a';
                el.style.borderColor = '#1e3a8a';
            }
        };

        async function loadAvailability(creatorCode) {
            try {
                const res = await fetch('https://velvet-chat-jjxw.vercel.app/api/availability?creatorCode=' + creatorCode);
                const data = await res.json();
                let existing = [];
                if (data.success && data.slots) {
                    // Convert slot objects back to key strings
                    // Note: availability API returns formatted slots, we store raw in Firestore directly
                }
                // Load raw slots from Firestore
                const availDoc = await getDoc(doc(db, 'availability', creatorCode));
                if (availDoc.exists()) {
                    const rawSlots = availDoc.data().slots || [];
                    existing = rawSlots.map(s => s.dayOfWeek + '_' + s.hour + '_' + (s.minute || 0));
                }
                buildTimePicker(existing);
            } catch(e) {
                console.error('Load availability error:', e);
                buildTimePicker([]);
            }
        }

        window.saveAvailability = async function() {
            const btn = document.getElementById('saveAvailBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const creatorCode = currentCreator.code;
                // Convert Set of "dayIdx_hour_minute" to slot objects
                const slots = Array.from(selectedSlots).map(key => {
                    const [dayOfWeek, hour, minute] = key.split('_').map(Number);
                    return { dayOfWeek, hour, minute };
                });

                const res = await fetch('https://velvet-chat-jjxw.vercel.app/api/availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ creatorCode, slots }),
                });

                const data = await res.json();
                if (data.success) {
                    document.getElementById('availMsg').style.display = 'block';
                    setTimeout(() => document.getElementById('availMsg').style.display = 'none', 3000);
                } else {
                    alert('Error saving: ' + data.error);
                }
            } catch(e) {
                alert('Error saving availability: ' + e.message);
            }

            btn.disabled = false;
            btn.textContent = 'Save Availability';
        };

        // â”€â”€ BOOKINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadBookings(creatorCode) {
            try {
                const res = await fetch('https://velvet-chat-jjxw.vercel.app/api/whereby?creatorCode=' + creatorCode);
                const data = await res.json();
                const container = document.getElementById('bookingsContainer');

                if (!data.success || data.bookings.length === 0) {
                    container.innerHTML = '<div class="loading">No upcoming calls booked yet.</div>';
                    return;
                }

                // Only show future bookings
                const now = new Date();
                const upcoming = data.bookings.filter(b => new Date(b.scheduledAt) > now && b.status === 'confirmed');

                if (upcoming.length === 0) {
                    container.innerHTML = '<div class="loading">No upcoming calls.</div>';
                    return;
                }

                let html = '';
                upcoming.forEach(booking => {
                    const dt = new Date(booking.scheduledAt);
                    const dateStr = dt.toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'short' });
                    const timeStr = dt.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
                    const minsUntil = Math.round((dt - now) / 60000);
                    const canJoin = minsUntil <= 10;

                    html += '<div style="background:#f8f8f8;border-radius:12px;padding:16px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">';
                    html += '<div>';
                    html += '<div style="font-weight:600;font-size:15px;">' + dateStr + ' at ' + timeStr + '</div>';
                    html += '<div style="font-size:13px;color:#666;margin-top:2px;">' + booking.duration + ' min call Â· Client ID: ' + booking.userId.slice(0,8) + '...</div>';
                    if (minsUntil <= 60) {
                        html += '<div style="font-size:12px;color:#e74c3c;margin-top:4px;">Starting in ' + minsUntil + ' mins</div>';
                    }
                    html += '</div>';
                    html += '<button onclick="openCreatorCall(\'' + booking.hostRoomUrl + '\')" style="padding:10px 16px;background:' + (canJoin ? '#27ae60' : 'linear-gradient(135deg,#c2185b,#880e4f)') + ';color:#fff;border-radius:10px;font-size:14px;font-weight:600;border:none;cursor:pointer;">' + (canJoin ? 'ðŸŸ¢ Join Now' : 'ðŸ“¹ Join') + '</button>';
                    html += '</div>';
                });

                container.innerHTML = html;
            } catch(e) {
                console.error('Load bookings error:', e);
                document.getElementById('bookingsContainer').innerHTML = '<div class="loading">Error loading bookings.</div>';
            }
        }

        // Logout handled in plain script below
    </script>
    <!-- Velvet Video Call Overlay (creator only) -->
    <div id="velvetCallOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;background:#1a0a2e;flex-direction:column;">
        <!-- Top bar -->
        <div style="background:linear-gradient(135deg,#880e4f,#2d0a1e);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
            <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:18px;">ðŸ’‹</span>
                <span style="font-family:Georgia,serif;font-size:22px;font-weight:700;color:#fff;letter-spacing:3px;" id="callOverlayTitle">VELVET</span>
                <span style="font-size:18px;">ðŸ’—</span>
            </div>
            <button onclick="endCreatorCall()" style="background:rgba(255,255,255,0.15);border:none;color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;cursor:pointer;">âœ• End Call</button>
        </div>
        <!-- Hearts border strip -->
        <div id="heartsBorder" style="background:linear-gradient(135deg,#2d0a1e,#880e4f,#2d0a1e);padding:6px 0;text-align:center;font-size:16px;letter-spacing:4px;flex-shrink:0;overflow:hidden;white-space:nowrap;">
            ðŸ’— ðŸ’‹ ðŸ’• ðŸ’— ðŸ’‹ ðŸ’• ðŸ’— ðŸ’‹ ðŸ’• ðŸ’— ðŸ’‹ ðŸ’• ðŸ’— ðŸ’‹ ðŸ’• ðŸ’— ðŸ’‹ ðŸ’• ðŸ’— ðŸ’‹ ðŸ’• ðŸ’— ðŸ’‹ ðŸ’•
        </div>
        <!-- Whereby iframe -->
        <iframe id="creatorCallFrame" src="" allow="camera;microphone;fullscreen;speaker;display-capture" style="flex:1;width:100%;border:none;"></iframe>
        <!-- Hearts border strip bottom -->
        <div style="background:linear-gradient(135deg,#2d0a1e,#880e4f,#2d0a1e);padding:6px 0;text-align:center;font-size:16px;letter-spacing:4px;flex-shrink:0;overflow:hidden;white-space:nowrap;">
            ðŸ’‹ ðŸ’— ðŸ’• ðŸ’‹ ðŸ’— ðŸ’• ðŸ’‹ ðŸ’— ðŸ’• ðŸ’‹ ðŸ’— ðŸ’• ðŸ’‹ ðŸ’— ðŸ’• ðŸ’‹ ðŸ’— ðŸ’• ðŸ’‹ ðŸ’— ðŸ’• ðŸ’‹ ðŸ’— ðŸ’•
        </div>
    </div>

    <script>
        function openCreatorCall(url) {
            const overlay = document.getElementById('velvetCallOverlay');
            const nameEl = document.getElementById('callOverlayTitle');
            if (nameEl && window._creatorFirstName) {
                nameEl.textContent = window._creatorFirstName.toUpperCase() + "'S VELVET VIDEO CHAT";
            }
            const frame = document.getElementById('creatorCallFrame');
            const urlObj = new URL(url);
            urlObj.searchParams.set('minimal', '1');
            urlObj.searchParams.set('background', 'off');
            urlObj.searchParams.set('chat', 'off');
            urlObj.searchParams.set('people', 'off');
            urlObj.searchParams.set('logo', 'off');
            urlObj.searchParams.set('topToolbar', 'off');
            urlObj.searchParams.set('bottomToolbar', 'on');
            frame.src = urlObj.toString();
            overlay.style.display = 'flex';
        }

        function endCreatorCall() {
            document.getElementById('velvetCallOverlay').style.display = 'none';
            document.getElementById('creatorCallFrame').src = '';
        }

        async function logout() {
            if (confirm('Logout?')) {
                const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getAuth, signOut } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const apps = getApps();
                if (apps.length > 0) {
                    const auth = getAuth(apps[0]);
                    await signOut(auth);
                }
                window.location.href = 'creator-login.html';
            }
        }
    </script>
</body>
</html>